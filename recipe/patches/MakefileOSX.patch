From 2551d6276de49ea3494c4bd1bcbd465bf1810257 Mon Sep 17 00:00:00 2001
From: Ivan Iziumov <iiziumov@anaconda.com>
Date: Mon, 12 Jan 2026 15:22:59 +0100
Subject: [PATCH] fix makefile OSX

---
 Makefile | 75 ++++++++++++++++++++------------------------------------
 1 file changed, 27 insertions(+), 48 deletions(-)

diff --git a/Makefile b/Makefile
index b690833..633b04d 100644
--- a/Makefile
+++ b/Makefile
@@ -73,11 +73,7 @@ endif
 MKTGTDIR = mkdir -p $(dir $@)
 CC_CMD = $(QUIET_CC) $(MKTGTDIR) ; $(CC) $(CFLAGS) -MMD -MP -o $@ -c $<
 CXX_CMD = $(QUIET_CXX) $(MKTGTDIR) ; $(CXX) $(CFLAGS) $(XCXXFLAGS) -MMD -MP -o $@ -c $<
-ifeq ($(USE_ARGUMENT_FILE),yes)
-  AR_CMD = $(QUIET_AR) $(MKTGTDIR) ; $(AR) cr $@ $(file > $@.in,$^) @$@.in
-else
-  AR_CMD = $(QUIET_AR) $(MKTGTDIR) ; $(AR) cr $@ $^
-endif
+AR_CMD = $(QUIET_AR) $(MKTGTDIR) ; $(AR) cr $@ $^
 ifdef RANLIB
   RANLIB_CMD = $(QUIET_RANLIB) $(RANLIB) $@
 endif
@@ -327,41 +323,33 @@ generate: source/html/css-properties.h

 # --- Library ---

-ifeq ($(shared),yes)
-  $(OUT)/libmupdf.$(SO)$(SO_VERSION): $(MUPDF_OBJ) $(THIRD_OBJ)
-	$(LINK_SO_CMD) $(THIRD_LIBS) $(LIBCRYPTO_LIBS) $(LIBS)
-  ifeq ($(OS),OpenBSD)
-    # should never create symlink
-    MUPDF_LIB = $(OUT)/libmupdf.$(SO)$(SO_VERSION)
-  else
-    MUPDF_LIB = $(OUT)/libmupdf.$(SO)
-    ifneq ($(SO_VERSION),)
-      # create symlink with soname if needed
-      $(OUT)/libmupdf.$(SO): $(OUT)/libmupdf.$(SO)$(SO_VERSION)
-	$(SYMLINK_CMD) $(notdir $<) $@
-    endif
-  endif
-else
-  MUPDF_LIB = $(OUT)/libmupdf.a
-  ifneq ($(THIRD_OBJ),)
-    # omit libmupdf-third if there is nothing in it
-    THIRD_LIB = $(OUT)/libmupdf-third.a
-  endif
-  $(MUPDF_LIB) : $(MUPDF_OBJ)
-  $(THIRD_LIB) : $(THIRD_OBJ)
-endif
+MUPDF_LIB = $(OUT)/libmupdf.$(SO)
+LIBS_TO_INSTALL_IN_LIB = $(MUPDF_LIB)
+THIRD_LIB = $(OUT)/libmupdf-third.$(SO)
+PKCS7_LIB = $(OUT)/libmupdf-pkcs7.$(SO)
+THREAD_LIB = $(OUT)/libmupdf-threads.$(SO)
+
+$(MUPDF_LIB) : $(MUPDF_OBJ)
+$(THIRD_LIB) : $(THIRD_OBJ)
+$(THREAD_LIB) : $(THREAD_OBJ)
+$(PKCS7_LIB) : $(PKCS7_OBJ)
+
+$(MUPDF_LIB) : $(MUPDF_OBJ) $(THIRD_LIB) $(THREAD_LIB)
+	$(LINK_CMD) -shared -Wl,-install_name -Wl,libmupdf.$(SO) -undefined dynamic_lookup $(THIRD_LIBS)
+$(THIRD_LIB) : $(THIRD_OBJ)
+	$(LINK_CMD) -shared -Wl,-install_name -Wl,libmupdf-third.$(SO) -undefined dynamic_lookup
+$(THREAD_LIB) : $(THREAD_OBJ)
+	$(LINK_CMD) -shared -Wl,-install_name -Wl,libmupdf-threads.$(SO) -undefined dynamic_lookup -lpthread
+$(PKCS7_LIB) : $(PKCS7_OBJ)
+	$(LINK_CMD) -v -shared -Wl,-install_name -Wl,libmupdf-pkcs7.$(SO) -undefined dynamic_lookup
+
+LIBS_TO_INSTALL_IN_LIB := $(MUPDF_LIB) $(THIRD_LIB) $(THREAD_LIB) $(PKCS7_LIB)

 ifneq ($(USE_SYSTEM_GLUT),yes)
   THIRD_GLUT_LIB = $(OUT)/libmupdf-glut.a
   $(THIRD_GLUT_LIB) : $(THIRD_GLUT_OBJ)
 endif

-THREAD_LIB = $(OUT)/libmupdf-threads.a
-$(THREAD_LIB) : $(THREAD_OBJ)
-
-PKCS7_LIB = $(OUT)/libmupdf-pkcs7.a
-$(PKCS7_LIB) : $(PKCS7_OBJ)
-
 # --- Main tools and viewers ---

 MUTOOL_SRC := source/tools/mutool.c
@@ -489,14 +477,10 @@ install-headers:
 install-libs: libs install-headers
 	install -d $(DESTDIR)$(libdir)
 ifeq ($(shared),yes)
-	install -m $(SO_INSTALL_MODE) $(OUT)/libmupdf.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/libmupdf.$(SO)$(SO_VERSION)
-  ifneq ($(OS),OpenBSD)
-	ln -sf libmupdf.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/libmupdf.$(SO)$(SO_VERSION_MAJOR)
-	ln -sf libmupdf.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/libmupdf.$(SO)
-  endif
+	@for lib in $(LIBS_TO_INSTALL_IN_LIB); do \
+		install -m 644 $$lib $(DESTDIR)$(libdir); \
+	done
 else
-	install -m 644 $(MUPDF_LIB) $(DESTDIR)$(libdir)
-	install -m 644 $(THIRD_LIB) $(DESTDIR)$(libdir)
 endif

 install-tools: tools
@@ -518,9 +502,8 @@ install-docs:
 	install -d $(DESTDIR)$(docdir)/examples
 	install -m 644 README CHANGES $(DESTDIR)$(docdir)
 	install -m 644 $(wildcard COPYING LICENSE) $(DESTDIR)$(docdir)
-	install -m 644 docs/examples/* $(DESTDIR)$(docdir)/examples

-install: install-libs install-apps install-docs
+install: install-libs install-apps

 docs:
 	bash scripts/build-docs.sh
@@ -677,14 +660,10 @@ install-shared-c: install-shared-check install-libs install-headers
 install-shared-c++: install-shared-c c++
 	install -m 644 platform/c++/include/mupdf/*.h $(DESTDIR)$(incdir)/mupdf
 	install -m $(SO_INSTALL_MODE) $(OUT)/libmupdfcpp.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/
-ifneq ($(OS),OpenBSD)
-	ln -sf libmupdfcpp.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/libmupdfcpp.$(SO)
-	ln -sf libmupdfcpp.$(SO)$(SO_VERSION) $(DESTDIR)$(libdir)/libmupdfcpp.$(SO)$(SO_VERSION_MAJOR)
-endif

 install-shared-python: install-shared-c++ python
 	install -d $(DESTDIR)$(pydir)/mupdf
-	install -m $(SO_INSTALL_MODE) $(OUT)/_mupdf.$(SO) $(DESTDIR)$(pydir)/mupdf
+	install -m $(SO_INSTALL_MODE) $(OUT)/_mupdf.so $(DESTDIR)$(pydir)/mupdf
 	install -m 644 $(OUT)/mupdf.py $(DESTDIR)$(pydir)/mupdf/__init__.py

 else
--
2.51.0
